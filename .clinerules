# Command Center Project Rules

## Architecture
Fully modularized as of Feb 2026. `app.js` is a 241-line orchestration shell. All feature code lives in dedicated module files. See `MODULARIZATION.md` for the complete module→function map and script load order.

## Module Map (quick reference)
- `core.js` (~10 lines) — Data layer: load/save/today/weekId/dayData/weekData/getGlobal/addLog/escHtml
- `calendar.js` (~520 lines) — Day calendar rendering, goal CRUD, Italian work, reflection
- `flashcard-review.js` (~228 lines) — Shared card review modal (used by Cards, Translate, Claude)
- `today.js` (~120 lines) — Today tab orchestration
- `week.js` (~53 lines) — Week tab
- `dissertation.js` (~200 lines) — Dissertation tab
- `chat.js` (~66 lines) — Claude tab
- `anki.js` (~607 lines) — SM-2 flashcard engine (Cards tab)
- `translate.js` (~294 lines) — Read/Translate tab
- `aotd.js` (~412 lines) — Article of the Day
- `meals.js` (~350 lines) — Meals tab (food diary, meal library, macro tracking)
- `progress.js` (~300 lines) — Progress tab (charts, weekly summaries)
- `app.js` (~241 lines) — Nav, notes, keyboard, auto-seal, sync UI, init
- `firebase-sync.js` (~350 lines) — Firebase sync (loaded last)

## Critical Rules

### 1. Read MODULARIZATION.md before any feature work
Before touching any feature, read `MODULARIZATION.md` to know which file(s) own the relevant code. Never guess which file contains a function — check the map.

### 2. One tab at a time
When modifying a feature, only read the module file(s) for that tab. Don't read unrelated modules "for context." The Tab → File Mapping in MODULARIZATION.md tells you exactly what to open.

### 3. File size gate
Before reading any file, check its size: `wc -l <file>`
- Under 400 lines: safe to read in full
- Over 400 lines AND context > 50%: use `grep -n` to find the section, then `sed -n 'START,ENDp'` to read only what you need
- `index.html` (~590 lines): always grep for the tab section you need, never read in full

### 4. Context checkpoint at 60%
At 60% context usage: pause and assess. Can you finish the current task? If not, commit what you have and note remaining work in `continuation.md`.

### 5. Hard stop at 80%
At 80% context usage:
1. Commit all working changes immediately
2. Update `continuation.md` with: what was done, what remains, which files are affected
3. Generate a continuation prompt the user can paste into a new task
4. Do NOT start reading new files or making new changes

### 6. Anti-bloat rule (700-line ceiling)
No single JS file should exceed 700 lines. If a module grows past that threshold during edits, split it before committing. This prevents re-monolithification. If you're about to add significant code to a file, check `wc -l` first.

### 7. Always commit working states
After any successful change, `git commit` immediately. Never leave uncommitted work that spans multiple logical changes. Commit messages should name the module(s) changed.

### 8. Keep documentation in sync
When modifying any module file:
- Update `MODULARIZATION.md` if functions are added, removed, moved, or renamed
- Update `sw.js` ASSETS array if files are added, removed, or renamed
- After any structural change, verify `index.html` script tags match actual module files

### 9. Data layer is read-only knowledge
`core.js` exports: `load()`, `save()`, `today()`, `weekId()`, `dayData()`, `weekData()`, `getGlobal()`, `addLog()`, `escHtml()`. You never need to read their implementations — just know they exist and are globally available.

### 10. Formatting: no markdown tables
Use lists instead of tables in all responses. Tables render poorly in the Cline browser window.

### 11. Script load order matters
```
core.js → calendar.js → flashcard-review.js → today.js → week.js → dissertation.js → chat.js → anki.js → translate.js → aotd.js → app.js → firebase-sync.js
```
- `core.js` must be first (everything depends on it)
- `app.js` must be after all feature modules (it calls their render functions)
- `firebase-sync.js` must be last (it depends on everything)
- If adding a new module, insert it before `app.js` and after its dependencies